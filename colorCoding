from openpyxl.utils.dataframe import dataframe_to_rows
from openpyxl import Workbook

# Helper function to add pivot table (handles empty pivots)
def add_pivot_to_sheet(ws, start_row, title, pivot_table):
    # If the pivot table is empty, we add a placeholder message
    if pivot_table.empty:
        ws.cell(row=start_row, column=1, value=title)
        ws.cell(row=start_row + 1, column=1, value="No Data Available")
        return start_row + 3  # Move to next available row with some space
    else:
        # If the pivot table has data, write it to the sheet
        ws.cell(row=start_row, column=1, value=title)
        for r_idx, row in enumerate(dataframe_to_rows(pivot_table, index=True, header=True), start=start_row + 1):
            for c_idx, value in enumerate(row, start=1):
                ws.cell(row=r_idx, column=c_idx, value=value)
        return start_row + len(pivot_table) + 4  # Leave space for the next pivot

# Function to process and save data, including pivot handling
def process_and_save(input_file, exclusion_file, output_file, country, log_text):
    try:
        log_text.insert(tk.END, "Processing started...\n")

        # Load input and exclusion files
        excel_data = pd.ExcelFile(input_file)
        exclusion_list = pd.read_excel(exclusion_file)
        log_text.insert(tk.END, f"Loaded data for {country}...\n")

        # Define configurations for each country
        country_config = {
            "India": {"filter_team": True},
            "China": {"filter_team": False},
        }

        # Check if the selected country is valid
        if country not in country_config:
            raise ValueError(f"Configuration for {country} is not defined.")

        # Load the sheet for the selected country
        df = excel_data.parse(country)

        # Get configuration values
        filter_team = country_config[country]["filter_team"]
        current_date = datetime.now().date()

        # Step 1: Add raw data
        wb = Workbook()
        ws_raw = wb.create_sheet(title=f"{country} Raw Data")
        for r_idx, row in enumerate(dataframe_to_rows(df, index=False, header=True), start=1):
            for c_idx, value in enumerate(row, start=1):
                ws_raw.cell(row=r_idx, column=c_idx, value=value)

        # Step 2: Filter data
        filtered_df = filter_data(df, current_date, filter_team)
        ws_filtered = wb.create_sheet(title=f"{country} Filtered Data")
        for r_idx, row in enumerate(dataframe_to_rows(filtered_df, index=False, header=True), start=1):
            for c_idx, value in enumerate(row, start=1):
                ws_filtered.cell(row=r_idx, column=c_idx, value=value)

        # Step 3: Generate pivot tables
        pivots = create_pivots(filtered_df, exclusion_list)
        ws_pivots = wb.create_sheet(title=f"{country} Pivot Tables")
        start_row = 1

        # Add each pivot table, handle empty tables with a placeholder
        for title, pivot_table in pivots:
            start_row = add_pivot_to_sheet(ws_pivots, start_row, title, pivot_table)

        # Remove the default sheet created by openpyxl
        if "Sheet" in wb.sheetnames:
            del wb["Sheet"]

        # Save the final workbook
        wb.save(output_file)
        log_text.insert(tk.END, f"Processing completed. Output saved to {output_file}\n")
    except Exception as e:
        log_text.insert(tk.END, f"Error: {e}\n")
        messagebox.showerror("Error", str(e))
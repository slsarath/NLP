import json
from wordcloud import WordCloud
import matplotlib.pyplot as plt

st.markdown("### ‚òÅÔ∏è AI-Generated WordClouds of Top Incident Themes")

# Step 1: Prompt OpenAI to get top incident themes per department
incident_summary_prompt = (
    "You are a data analyst. I will provide incident data with columns: Incident ID, Incident Date, "
    "Department, Description. For each department, identify the top 5 most frequently occurring incident themes "
    "based on the Description column. Return the result as a JSON dictionary in this format:\n\n"
    "{\n"
    "  'Department1': {'theme1': count, 'theme2': count, ...},\n"
    "  'Department2': {...},\n"
    "  ...\n"
    "}\n\n"
    "Here is the incident data:\n"
)
sample_data = incident_df[['Department', 'Description']].to_csv(index=False)

# Step 2: Get OpenAI response
response = client.chat.completions.create(
    model=deployment_name,
    messages=[
        {"role": "system", "content": "You are a helpful assistant skilled in summarizing incidents."},
        {"role": "user", "content": incident_summary_prompt + sample_data}
    ],
    temperature=0.3,
    max_tokens=1000
)

# Step 3: Parse response
try:
    text_response = response.choices[0].message.content
    cleaned_text = text_response.strip().replace("```json", "").replace("```", "")
    theme_dict = json.loads(cleaned_text)

    # Step 4: Department dropdown
    departments = list(theme_dict.keys())
    selected_dept = st.selectbox("Select a department to view incident themes:", departments)

    if selected_dept:
        theme_data = theme_dict[selected_dept]
        st.markdown(f"#### üè¢ Department: {selected_dept}")
        wordcloud = WordCloud(width=600, height=300, background_color='white').generate_from_frequencies(theme_data)
        fig, ax = plt.subplots(figsize=(8, 3))
        ax.imshow(wordcloud, interpolation='bilinear')
        ax.axis("off")
        st.pyplot(fig)

except Exception as e:
    st.error(f"Failed to generate WordCloud. Error: {e}")
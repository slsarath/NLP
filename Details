import win32com.client as win32

# Initialize Excel application
excel = win32.gencache.EnsureDispatch('Excel.Application')
excel.Visible = False  # Run Excel in the background

# Open master workbook and temporary workbook
master_wb = excel.Workbooks.Open(master_book_xlsx_file_path)
test_master_wb = excel.Workbooks.Open(master_temp_file)

# Get active sheets
sheet_master = master_wb.ActiveSheet
sheet_temp = test_master_wb.ActiveSheet

# Find the last rows in both sheets
last_row_master = sheet_master.Cells(sheet_master.Rows.Count, TradeId).End(-4162).Row
last_row_temp = sheet_temp.Cells(sheet_temp.Rows.Count, TradeId).End(-4162).Row

# Create a set of TradeIds from the temporary sheet for quick lookup
temp_trade_ids = set()
for row_temp in range(1, last_row_temp + 1):
    ch_id_temp = sheet_temp.Cells(row_temp, TradeId).Value
    temp_trade_ids.add(ch_id_temp)

# Iterate through the master sheet from the bottom up to avoid issues when deleting rows
for row in range(last_row_master, 3, -1):  # Start from the last row to row 4
    ch_id_master = sheet_master.Cells(row, TradeId).Value
    if ch_id_master not in temp_trade_ids:
        sheet_master.Rows(row).Delete()  # Delete rows that don't match

# Now update the matching rows
for row in range(4, last_row_master + 1):
    ch_id_master = sheet_master.Cells(row, TradeId).Value
    for row_temp in range(1, last_row_temp + 1):
        ch_id_temp = sheet_temp.Cells(row_temp, TradeId).Value
        if ch_id_master == ch_id_temp:
            sheet_master.Cells(row, Level_4).Value = sheet_temp.Cells(row_temp, Level_4).Value
            sheet_master.Cells(row, Level_5).Value = sheet_temp.Cells(row_temp, Level_5).Value
            sheet_master.Cells(row, Level_6).Value = sheet_temp.Cells(row_temp, Level_6).Value
            sheet_master.Cells(row, Level_7).Value = sheet_temp.Cells(row_temp, Level_7).Value
            sheet_master.Cells(row, Controller1).Value = sheet_temp.Cells(row_temp, Controller1).Value
            sheet_master.Cells(row, ReportingDate).Value = sheet_temp.Cells(row_temp, ReportingDate).Value

# Save the updated master workbook
master_wb.Save()

# Clean up by closing workbooks and quitting Excel
test_master_wb.Close(False)
master_wb.Close(True)
excel.Quit()
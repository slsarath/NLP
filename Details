import re
import pandas as pd
from dateutil import parser

# Sample DataFrame with extracted narrative values
data = {'Narrative Extracted': [
    'March 2023, June 2023, September 2023',
    '01/08/2023',
    '10th May 2024',
    'April 2023, May 2023, October 2023',
    '03 2022, 08 2022',
]}

df = pd.DataFrame(data)

# Function to convert month/year or quarter/year to standard format YYYYQn
def process_narrative(text):
    quarter_years = []

    # Pattern for months like "March 2023", "10th May 2024", or date formats like "01/08/2023"
    month_pattern = r'(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s?\d{4}|\d{2}/\d{2}/\d{4}'
    # Pattern for "Q" references like "Q3" or "Q3 2023"
    quarter_pattern = r'(Q[1-4])\s?(\d{4})?'
    # Pattern for year only like "2023"
    year_pattern = r'\b\d{4}\b'

    # Find all month-based references (like "March 2023" or "01/08/2023")
    months = re.findall(month_pattern, text)
    for month_ref in months:
        # Parse the date and determine the quarter
        try:
            date_obj = parser.parse(month_ref)
            quarter = (date_obj.month - 1) // 3 + 1  # Get quarter from month
            quarter_years.append(f"{date_obj.year}Q{quarter}")
        except Exception as e:
            print(f"Error parsing date: {e}")
            continue

    # Find all quarter-based references
    quarters = re.findall(quarter_pattern, text)
    for q, year in quarters:
        if not year:
            year = "2023"  # Default to current year if year is missing
        quarter_years.append(f"{year}{q}")

    # Sort quarter references and keep only the latest one
    if quarter_years:
        latest_quarter = max(quarter_years)
        return latest_quarter
    return "No Date/Quarter Found"

# Apply the function to the DataFrame
df['Latest Quarter Reference'] = df['Narrative Extracted'].apply(process_narrative)

# Output the DataFrame to check the results
print(df)
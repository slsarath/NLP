import pandas as pd
import re

# Define regex patterns for each category with word boundaries
patterns = {
    "Source of Funds": [
        r"(?i)source of funds[:\-\?\s]*", r"(?i)sow summary[:\-\?\s]*",
        r"(?i)sow[:\-\?\s]*", r"(?i)\?source of funds\?", r"(?i)source[\s]*[\-\[\]]*"
    ],
    "Purpose of Funds": [
        r"(?i)purpose of these funds[:\-\?\s]*", r"(?i)pof[:\-\?\s]*", 
        r"(?i)wf/pof[:\-\?\s]*", r"(?i)purpose[:\-\?\s]*"
    ],
    "Where the Funds Have Come From": [
        r"(?i)where the funds have come from[:\-\?\s]*", r"(?i)wf[:\-\?\s]*", 
        r"(?i)bwwf[:\-\?\s]*"
    ],
    "Rationale": [
        r"(?i)rationale[:\-\?\s]*", r"(?i)r[:\-\?\s]*", 
        r"(?i)rationale why[\s\w]*[:\-\?\s]*"
    ]
}

# Combine all patterns into a regex pattern for sentence boundaries
all_patterns = "|".join([pat for sublist in patterns.values() for pat in sublist])

def extract_statements(text, patterns, all_patterns):
    """
    Extracts statements after predefined expressions using regex but stops at the next key phrase.
    """
    extracted_data = {category: None for category in patterns.keys()}

    if not text or not isinstance(text, str):
        return extracted_data  # Return empty if no valid text

    for category, regex_list in patterns.items():
        for regex in regex_list:
            match = re.search(regex + r"(.*?)(?=" + all_patterns + r"|$)", text, re.IGNORECASE | re.DOTALL)
            if match:
                extracted_data[category] = match.group(1).strip()
                break  # Stop at first match

    return extracted_data

# Sample DataFrame
data = {
    "comments": [
        "Source of funds: Cash held in USD account 3333 55555 Where the funds have come from: Internal transfer from Wealth USD account into EDS account. Purpose of these funds: Transferred to NS&I for a better rate of interest. Rationale: we are comfortable with this transaction, funds originate from sale of Cente shares which paid in USD into this account earlier this month."
    ]
}

df = pd.DataFrame(data)

# Apply extraction function
results = df["comments"].apply(lambda x: extract_statements(x, patterns, all_patterns))

# Add extracted information as new columns dynamically
for category in patterns.keys():
    df[f"{category} Statement"] = results.apply(lambda x: x[category])

# Display DataFrame
import ace_tools as tools
tools.display_dataframe_to_user(name="Processed Commentary Data", dataframe=df)
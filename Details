import pandas as pd

# Read your dataset (adjust filename as needed)
df = pd.read_csv("risk_events.csv")

# Convert dates to datetime (ignoring errors for blanks/invalid formats)
df["Action Due Date"] = pd.to_datetime(df["Action Due Date"], errors="coerce")
df["Action Closed Date"] = pd.to_datetime(df["Action Closed Date"], errors="coerce")

# Extract month-year periods
df["Due_Month"] = df["Action Due Date"].dt.to_period("M")
df["Closed_Month"] = df["Action Closed Date"].dt.to_period("M")

# Closed On Time = status is Closed- Actions completed AND due month == closed month
df["Closed_On_Time"] = (
    (df["Action Status"] == "Closed- Actions completed") &
    (df["Due_Month"] == df["Closed_Month"])
)

# Late Closure = status is Closed- Actions completed AND closed month > due month
df["Late_Closure"] = (
    (df["Action Status"] == "Closed- Actions completed") &
    (df["Closed_Month"] > df["Due_Month"])
)

# Not Closed = not Closed- Actions completed (covers open, overdue, etc.)
df["Not_Closed"] = ~(df["Action Status"] == "Closed- Actions completed")

# Save the enriched dataset for Excel pivot
df.to_csv("risk_events_with_flags.csv", index=False)

print("Derived columns added and file saved as risk_events_with_flags.csv")